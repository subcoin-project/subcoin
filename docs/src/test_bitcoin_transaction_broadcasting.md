# Test `subcoin_sendRawTransaction`

<!-- clap-markdown-toc -->

*   [1. Start a subcoin node](#1-start-a-subcoin-node)
*   [2. Start a Bitcoin Core node](#2-start-a-bitcoin-core-node)
*   [3. Fetch a pending transaction from mempool](#3-fetch-a-pending-transaction-from-mempool)
*   [4. Broadcast the transaction](#4-broadcast-the-transaction)

<!-- /clap-markdown-toc -->

RPC `subcoin_sendRawTransaction` is used to submit a raw transaction in hex string to the local node and network, the submitted transaction will be broadcasted to the connected peers.

Here is how we'll test the functionality of this RPC:

- Start a subcoin node.
- Start a Bitcoin Core node with an empty mempool, connecting only the specified subcoin node.
- Fetch a pending transaction using API from mempool.space.
- Check the presence of the pending transaction before and after invoking the RPC `subcoin_sendRawTransaction`.

### 1. Start a subcoin node

```bash
# Note that the default RPC url for subcoin is 127.0.0.1:9944.
./target/release/subcoin run --listen=127.0.0.1:8888 -d tmp --log subcoin_network=debug
```

### 2. Start a Bitcoin Core node

Create a `test.conf` for the `rpcauth` and `rpcport` options.

```ini
# Username and hashed password for JSON-RPC connections. The field <userpw> comes in the format: <USERNAME>:<SALT>$<HASH>. RPC clients connect using rpcuser=<USERNAME>/rpcpassword=<PASSWORD> arguments. You can generate this value at https://jlopp.github.io/bitcoin-core-rpc-auth-generator/. This option can be specified multiple times.
# The following rpcauth value is generated by specifying both username and password to test. 
rpcauth=test:3ead8ce3dcb0dc9f6258137d8a820b7f$d1b21d8220633d365f4dce99213e07159b3240deb33789b5f4d2ccfd1c82c473
# Listen for JSON-RPC connections on this port
rpcport=9000
```

Start a `bitcoind` node. (Note that if this is a fresh `bitcoind` node, the data of broadcasted transaction may be requested on receiving the transaction ID. Try to keep the bitcoind node syncing for some blocks).

```bash
# -persistmempool=0 ensures there is no transactions in the pool on startup.
# -noconnect -connect=127.0.0.1:8888 ensures the bitcoind node only connects to the subcoin node.
./src/bitcoind -datadir=/tmp/btc-data -persistmempool=0 -noconnect=1 -connect=127.0.0.1:8888 -debug=net -conf=$PWD/test.conf
```

### 3. Fetch a pending transaction from mempool

Get a recent pending transaction using https://mempool.space/docs/api/rest#get-mempool-recent.

```bash
# Fetch the recent pending transactions and take the txid of first item.
curl -sSL "https://mempool.space/api/mempool/recent" | python3 -m json.tool | grep txid | head -n 1
    "txid": "4f45b6c6f34933e9f209431551d36f752ca2b18709e83f56f7223c59952e2b42",
```

Get the full transaction in hex.

```bash
# Replace TXID with the transaction ID we want to fetch.
# curl -sSL "https://mempool.space/api/tx/{{TXID}}/hex"
curl -sSL "https://mempool.space/api/tx/4f45b6c6f34933e9f209431551d36f752ca2b18709e83f56f7223c59952e2b42/hex"
```

A small python script `test_subcoin_sendRawTransaction.py` is provided for this step.

```python
import requests

# Define the URL
url = "https://mempool.space/api/mempool/recent"

def fetch_pending_transaction():
    # Send a GET request to the URL
    response = requests.get(url)

    # Check if the request was successful
    if response.status_code == 200:
        # Parse the JSON response
        recent_transactions = response.json()
        # Print the result
        print("==== Recent transactions:")
        print(recent_transactions)

        print("==== Txid of first transaction in the recent transaction list:")
        txid = recent_transactions[0]["txid"]
        print(txid)

        print("==== Fetching transaction in hex string:")
        response = requests.get(f"https://mempool.space/api/tx/{txid}/hex")
        print(response.text)

    else:
        # Print an error message if the request was not successful
        print(f"Failed to retrieve recent transactions: {response.status_code}")

fetch_pending_transaction()
```

Run `python3 test_subcoin_sendRawTransaction.py`:

```bash
python3 test_subcoin_sendRawTransaction.py
==== Recent transactions:
[{'txid': '4f45b6c6f34933e9f209431551d36f752ca2b18709e83f56f7223c59952e2b42', 'fee': 710, 'vsize': 99, 'value': 50000}, {'txid': 'a40e7f6534a289c0b2ec864886d606d7861644d0fe714382e3cf4b285c829376', 'fee': 712, 'vsize': 174, 'value': 781919031}, {'txid': '87fd7a9eb51a1225bfe5967178b115d0a0d62be834890e726fc83d326ecd2bfa', 'fee': 1266, 'vsize': 211, 'value': 68176}, {'txid': 'c10ca68cd682c880ee945bf46c81ff499d0f828ca7c50540fe0744e0cacc0f81', 'fee': 1435, 'vsize': 285, 'value': 87727756}, {'txid': 'd2a1c04ac9f1d3f26ed99ebfff8a58bca25a186d3945ba9b60e760e046c43788', 'fee': 564, 'vsize': 140, 'value': 2868167}, {'txid': '3bd4841935fe50616cc47cd38514dfbe277300e6464ad183d7778fb8ef09df48', 'fee': 564, 'vsize': 140, 'value': 52310}, {'txid': '848762114fa3dfd937ed6d4de2fd7b23ccb41a4f9815a46b3cd0d7118aa1fdb0', 'fee': 564, 'vsize': 140, 'value': 131887}, {'txid': '93a8359dd8749be74ec811841134b0bbd4b2428f871aaeb3dd1b0a322c934d04', 'fee': 964, 'vsize': 141, 'value': 68322}, {'txid': 'ce349b628d7a6520331dc6c6cc75c02656f337ab5eb8625ece29a9ef6234f2fb', 'fee': 985, 'vsize': 197, 'value': 14147}, {'txid': '0101166e0abc508ead0cda10e1b5ade23e48f6ee228ea3abab8e788f63b77e4f', 'fee': 1887, 'vsize': 377, 'value': 3478}]
==== Txid of first transaction in the recent transaction list:
4f45b6c6f34933e9f209431551d36f752ca2b18709e83f56f7223c59952e2b42
==== Fetching transaction in hex string:
0200000000010187e47d1ae0bf05530bcd97bfb6b3879c58bcabb4e89951df1f307e0e3c8bb2e80300000000ffffffff018ac00000000000001600149e142d6b0d25d3fcde9102cbf17828f3e05f051f01406e3cb634234591661c1a4c52615bb5a543f099400b872dd94d39688f45bca29f28066782ca44012d27b5c1c9a528e376857d3f076c27123ea77b0041f54e8cd200000000
```

### 4. Broadcast the transaction

Now we can broadcast the transaction via RPC `subcoin_sendRawTransaction` to the Bitcoin Core node.

The transaction is not in the mempool of `bitcoind` before the broadcasting.

```bash
# Replace TXID with the transaction ID we want to fetch.
# ./src/bitcoin-cli -datadir=/tmp/btc-data -conf=$PWD/test.conf getrawtransaction TXID
# The transaction does not exist in the mempool at this moment.
./src/bitcoin-cli -datadir=/tmp/btc-data -conf=$PWD/test.conf 4f45b6c6f34933e9f209431551d36f752ca2b18709e83f56f7223c59952e2b42
error code: -5
error message:
No such mempool or blockchain transaction. Use gettransaction for wallet transactions.
```

Now submit the transaction via `subcoin_sendRawTransaction`.

```bash
curl --location 'http://127.0.0.1:9944' \
--header 'Content-Type: application/json' \
--data '{
    "jsonrpc": "2.0",
    "method": "subcoin_sendRawTransaction",
    "params": [
        "0200000000010187e47d1ae0bf05530bcd97bfb6b3879c58bcabb4e89951df1f307e0e3c8bb2e80300000000ffffffff018ac00000000000001600149e142d6b0d25d3fcde9102cbf17828f3e05f051f01406e3cb634234591661c1a4c52615bb5a543f099400b872dd94d39688f45bca29f28066782ca44012d27b5c1c9a528e376857d3f076c27123ea77b0041f54e8cd200000000"
    ],
    "id": 1
}'
```

Check the mempool of `bitcoind` again, now we should see the transaction is present there, thus the transaction has been broadcasted to the bitcoind node and the RPC works as expected.

```bash
# Now the transaction exists in the mempool.
./src/bitcoin-cli -datadir=/tmp/btc-data -conf=$PWD/test.conf 4f45b6c6f34933e9f209431551d36f752ca2b18709e83f56f7223c59952e2b42
0200000000010187e47d1ae0bf05530bcd97bfb6b3879c58bcabb4e89951df1f307e0e3c8bb2e80300000000ffffffff018ac00000000000001600149e142d6b0d25d3fcde9102cbf17828f3e05f051f01406e3cb634234591661c1a4c52615bb5a543f099400b872dd94d39688f45bca29f28066782ca44012d27b5c1c9a528e376857d3f076c27123ea77b0041f54e8cd200000000
```
