<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Subcoin Book</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="A comprehensive guide to Subcoin, a Bitcoin Node in Substrate.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="src/css/custom.css">

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">Dev Guide</li><li class="chapter-item expanded "><a href="architecture.html"><strong aria-hidden="true">1.</strong> Architecture</a></li><li class="chapter-item expanded affix "><li class="part-title">User Guide</li><li class="chapter-item expanded "><a href="import-bitcoind-blocks.html"><strong aria-hidden="true">2.</strong> Import Bitcoin Core Blocks</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Subcoin Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/subcoin-project/subcoin" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="subcoin"><a class="header" href="#subcoin">Subcoin</a></h1>
<p><a href="https://t.me/subcoin_project"><img src="https://img.shields.io/badge/Telegram-blue?color=gray&amp;logo=telegram&amp;logoColor=%#64b5ef" alt="Telegram" /></a></p>
<img src="https://raw.githubusercontent.com/subcoin-project/subcoin/main/docs/src/images/subcoin-high-resolution-logo.png" alt="Subcoin logo" style="max-width: 400px; width: 100%; display: block; margin: 0 auto;">
<p style="text-align: center">
Subcoin is Bitcoin full node written in Rust using the <a href="https://github.com/paritytech/polkadot-sdk">Substrate framework</a>
</p>
<p>Subcoin's most significant contribution is introducing decentralized fast sync to
the Bitcoin ecosystem. Unlike traditional initial full sync, which require processing
every historical block and replaying all past transactions, fast sync downloads
the state at a specific block and begins normal block sync from that point.</p>
<h2 id="resources"><a class="header" href="#resources">Resources</a></h2>
<ul>
<li><a href="https://www.notion.so/liuchengxu/Subcoin-A-Step-Toward-Decentralized-Fast-Sync-for-Bitcoin-68762427a4484d73906a91602d789be9">Subcoin: A Step Toward Decentralized Fast Sync for Bitcoin</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="architecture"><a class="header" href="#architecture">Architecture</a></h1>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<img src="./images/Derive-Subcoin-from-Bitcoin.png" alt="Derive text" style="max-width: 600px; width: 100%; display: block; margin: 0 auto;">
<p>Subcoin operates similarly to how a Layer 2 chain is derived from a Layer 1 chain in a modular blockchain architecture. Each Subcoin block is deterministically derived from the corresponding Bitcoin block at the same height, faithfully replicating Bitcoin's transaction logic (Money Transfer).</p>
<p>The Bitcoin state (UTXO Set) is embedded within the Subcoin state, which includes a commitment to the global chain state (<code>state_root</code>). Effectively, Subcoin functions like Bitcoin with an added state root for the global Bitcoin state. This <code>state_root</code> enables possibilities like decentralized fast sync, without requiring any modifications to the Bitcoin protocol.</p>
<p>Additionally, Subcoin serves as an ideal testbed for new Bitcoin features, which are often challenging to land on the Bitcoin mainnet due to its stability and conservative development process. Developers can experiment with new innovations and features on Subcoin in a live environment without affecting the Bitcoin mainnet.</p>
<p>Subcoin is not a new blockchain but a replica of the Bitcoin chain with additional functionality, such as decentralized fast sync and flexibility for testing new features.</p>
<h2 id="code-map"><a class="header" href="#code-map">Code Map</a></h2>
<p>This section provides a brief overview of key directories and data structures in the project.</p>
<h3 id="cratespallet-bitcoin"><a class="header" href="#cratespallet-bitcoin"><code>crates/pallet-bitcoin</code></a></h3>
<p>This pallet is responsible for tracking the state of the UTXO Set. Transaction verification is deliberately excluded from this pallet, with all verifications handled on the client side through <code>sc-consensus-nakamoto</code>.</p>
<h3 id="cratessc-consensus-nakamoto"><a class="header" href="#cratessc-consensus-nakamoto"><code>crates/sc-consensus-nakamoto</code></a></h3>
<p>This crate manages the processing and importing of Bitcoin blocks into the database, whether they are sourced from a local Bitcoin Core database or downloaded via the P2P network.</p>
<ul>
<li><code>BitcoinBlockImporter</code>: Processes and imports blocks into the database.</li>
<li><code>BlockImportQueue</code>: Bridges blocks downloaded from the Bitcoin P2P network to BitcoinBlockImporter.</li>
</ul>
<h3 id="cratessubcoin-network"><a class="header" href="#cratessubcoin-network"><code>crates/subcoin-network</code></a></h3>
<p>This crate handles downloading Bitcoin blocks from the Bitcoin P2P network. The downloaded blocks are sent to the import queue, running in a separate task for processing. Block processing results are communicated back to ensure seamless integration.</p>
<h3 id="cratessubcoin-runtime"><a class="header" href="#cratessubcoin-runtime"><code>crates/subcoin-runtime</code></a></h3>
<p>This is a minimal Substrate runtime, composed of <code>frame-system</code> and <code>pallet-bitcoin</code>, which defines the core business logic of Subcoin chain.</p>
<h3 id="cratessubcoin-node"><a class="header" href="#cratessubcoin-node"><code>crates/subcoin-node</code></a></h3>
<p>The entry point for the Subcoin node is located at <code>crates/subcoin-node/src/bin/subcoin.rs</code>, which initializes and runs the node.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="import-blocks-from-bitcoin-core-database"><a class="header" href="#import-blocks-from-bitcoin-core-database">Import Blocks from Bitcoin Core Database</a></h1>
<!-- clap-markdown-toc -->
<ul>
<li><a href="import-bitcoind-blocks.html#get-the-bitcoind-binary">Get the <code>bitcoind</code> Binary</a></li>
<li><a href="import-bitcoind-blocks.html#run-subcoin-import-blocks">Run <code>subcoin import-blocks</code></a></li>
<li><a href="import-bitcoind-blocks.html#verify-the-utxo-set-state">Verify the UTXO Set State</a></li>
</ul>
<!-- /clap-markdown-toc -->
<p>If you already have a Bitcoin Core node with <code>-txindex</code> flag enabled, you can import the blocks from the Bitcoin Core database instead of downloading from the network.</p>
<h3 id="get-the-bitcoind-binary"><a class="header" href="#get-the-bitcoind-binary">Get the <code>bitcoind</code> Binary</a></h3>
<p>To have flexible control over <code>bitcoind</code> behavior, it’s recommended to compile the <code>bitcoind</code> binary from source rather than downloading it directly from <a href="https://github.com/bitcoin/bitcoin/releases">Bitcoin releases</a> which do not conveniently expose developer-oriented options. You can find the build instructions for your operating system under <code>build-*.md</code> in the <a href="https://github.com/bitcoin/bitcoin/tree/master/doc">Bitcoin repository</a>. For Linux, refer to <a href="https://github.com/bitcoin/bitcoin/blob/master/doc/build-unix.md">build-unix.md</a>.</p>
<pre><code class="language-bash"># Ensure these two commands exist after successfully compiling the Bitcoin Core source code.
./src/bitcoind --help
./src/bitcoin-cli --help
</code></pre>
<p>Next, start a <code>bitcoind</code> node with <code>txindex</code> and <code>coinstatsindex</code> enabled. <code>txindex</code> is necessary for importing blocks into Subcoin, and <code>coinstatsindex</code> is required to query and verify the UTXO set of a specific block later. For example, use <code>/tmp/btc-data</code> as the data directory:</p>
<pre><code class="language-bash">mkdir -p /tmp/btc-data &amp;&amp; ./src/bitcoind -datadir=/tmp/btc-data -txindex -coinstatsindex
</code></pre>
<p>Keep the <code>bitcoind</code> process running for a while to ensure it has synchronized a number of blocks. Note that <code>bitcoind</code> will first synchronize the block headers and only start downloading blocks after the headers are synced. This step might take some time depending on the peer connections (10+ minutes on my machine).</p>
<pre><code class="language-log">...
2024-07-11T17:23:10Z UpdateTip: new best=00000000000008c273c4c215892eacbafec33c199cfd3d9b539cdb6aafc39f54 height=142979 version=0x00000001 log2_work=66.385350 tx=1392173 date='2011-08-29T01:23:19Z' progress=0.001342 cache=33.0MiB(304442txo)
...
</code></pre>
<p>Stop the <code>bitcoind</code> process and proceed to import the blocks from the <code>bitcoind</code> database into Subcoin.</p>
<h3 id="run-subcoin-import-blocks"><a class="header" href="#run-subcoin-import-blocks">Run <code>subcoin import-blocks</code></a></h3>
<p>Ensure you have installed <code>subcoin</code>. If not, refer to <a href="./installation.html">installation</a> to install the <code>subcoin</code> binary.</p>
<pre><code class="language-bash"># Specify `subcoin-data` as the data directory for Subcoin and import the blocks from
# `/tmp/btc-data` which is the `bitcoind` database we set up earlier.
#
# `--state-pruning archive` is necessary for querying the state of the UTXO set later.
subcoin import-blocks /tmp/btc-data -d subcoin-data --state-pruning archive
</code></pre>
<p>You should see output similar to this:</p>
<pre><code class="language-log">2024-07-12 01:28:51 🔨 Initializing Genesis block/state (state: 0x1c68…f3f8, header-hash: 0xbdc8…a76b)
2024-07-12 01:28:53 🏁 CPU score: 1.15 GiBs
2024-07-12 01:28:53 🏁 Memory score: 13.87 GiBs
2024-07-12 01:28:53 🏁 Disk score (seq. writes): 1.77 GiBs
2024-07-12 01:28:53 🏁 Disk score (rand. writes): 678.77 MiBs
2024-07-12 01:28:53 Start loading block_index
2024-07-12 01:28:53 Successfully opened tx_index DB!
2024-07-12 01:28:53 Start to import blocks from #1 to #142984 from bitcoind database: /tmp/btc-data
2024-07-12 01:28:54 Imported 1000 blocks, best#1001,00000000a2887344f8db859e372e7e4bc26b23b9de340f725afbf2edb265b4c6 (0x3ff4…6eb5)
...
</code></pre>
<p>By default, Subcoin will import all blocks up to the latest indexed Bitcoin block in the <code>bitcoind</code> database. You can specify the total number of blocks to import or the target number of blocks to import:</p>
<pre><code class="language-bash"># Import 20000 blocks from the best block of Subcoin.
subcoin import-blocks /tmp/btc-data -d subcoin-data --block-count 20000

# Import blocks up to height 30000.
subcoin import-blocks /tmp/btc-data -d subcoin-data --end-block 30000
</code></pre>
<blockquote>
<p>NOTE:</p>
<p><em>The <code>bitcoind</code> process must be stopped when running the import-blocks command, otherwise you will encounter the following error</em>:</p>
<pre><code class="language-text">Error: Application(OpError { kind: None, message: "LevelDB error: IO error: lock /tmp/btc-data/blocks/index/LOCK: Resource temporarily unavailable" })
</code></pre>
</blockquote>
<h3 id="verify-the-utxo-set-state"><a class="header" href="#verify-the-utxo-set-state">Verify the UTXO Set State</a></h3>
<p><code>bitcoind</code> provides an interface to inspect the UTXO set state. This can be used to check the correctness of Subcoin’s UTXO set after importing blocks. For example, to export the UTXO set of <code>bitcoind</code> at height 10000:</p>
<pre><code class="language-bash"># Note that running this command requires the bitcoind process running in the background.
# If it was stopped, now restart it. You can stop it again after this command finishes.
./src/bitcoin-cli -datadir=/tmp/btc-data gettxoutsetinfo muhash 10000
{
  "height": 10000,
  "bestblock": "0000000099c744455f58e6c6e98b671e1bf7f37346bfd4cf5d0274ad8ee660cb",
  "txouts": 9494,
  "bogosize": 1109244,
  "muhash": "5a7c3a051a26d8cf61722f28fbbd3f0c2678698d008e5b7ec01e28a131c58def",
  "total_amount": 500000.00000000,
  "total_unspendable_amount": 50.00000000,
  "block_info": {
    "prevout_spent": 0.00000000,
    "coinbase": 50.00000000,
    "new_outputs_ex_coinbase": 0.00000000,
    "unspendable": 0.00000000,
    "unspendables": {
      "genesis_block": 0.00000000,
      "bip30": 0.00000000,
      "scripts": 0.00000000,
      "unclaimed_rewards": 0.00000000
    }
  }
}
</code></pre>
<p>Check the state of the UTXO set in Subcoin at the same height:</p>
<pre><code class="language-bash"># Note that the existing `gettxoutsetinfo` only displays a subset of the information in `bitcoind`.
subcoin blockchain gettxoutsetinfo --height 10000 -d subcoin-data
{
  "height": 10000,
  "bestblock": "0000000099c744455f58e6c6e98b671e1bf7f37346bfd4cf5d0274ad8ee660cb",
  "txouts": 9494,
  "bogosize": 1109244,
  "muhash": "5a7c3a051a26d8cf61722f28fbbd3f0c2678698d008e5b7ec01e28a131c58def",
  "total_amount": "500000.00000000"
}
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="mermaid.min.js"></script>
        <script src="mermaid-init.js"></script>

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
